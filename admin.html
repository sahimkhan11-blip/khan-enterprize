<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin | Khan Enterprize</title>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Poppins', sans-serif; padding: 20px; background: #f1f5f9; }
        .container { max-width: 1000px; margin: auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        h2 { border-bottom: 2px solid #2563eb; padding-bottom: 10px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 12px; border-bottom: 1px solid #eee; text-align: left; }
        th { background: #f8fafc; }
        select { padding: 5px; }
        .back-btn { display:inline-block; margin-bottom:15px; text-decoration:none; color:#2563eb; font-weight:bold; }
    </style>
</head>
<body>

    <div class="container">
        <a href="index.html" class="back-btn">‚Üê Back to Website</a>
        <h2>Admin Order Management</h2>
        <table>
            <thead>
                <tr>
                    <th>Customer</th>
                    <th>Items</th>
                    <th>Total</th>
                    <th>Status</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody id="order-list"></tbody>
        </table>
    </div>

    <script>
        // --- FIREBASE CONFIG (SAME AS INDEX.HTML) ---
        const firebaseConfig = {
            apiKey: "AIzaSyBxJai8n3-S1Lwh4Ndyobk0VTjXVbyJkPw",
            authDomain: "khan-enterprize.firebaseapp.com",
            projectId: "khan-enterprize",
            storageBucket: "khan-enterprize.firebasestorage.app",
            messagingSenderId: "876213493796",
            appId: "1:876213493796:web:ad9f8cdb93ceeba76e78b1",
            measurementId: "G-BMEQDVNJ6J"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // --- RENDER ORDERS ---
        function loadOrders() {
            db.collection("orders").orderBy("timestamp", "desc").onSnapshot(snap => {
                const list = document.getElementById('order-list');
                list.innerHTML = snap.docs.map(doc => {
                    const o = doc.data();
                    return `
                        <tr>
                            <td>${o.userName}<br><small>${o.phone}</small></td>
                            <td>${o.items}</td>
                            <td>${o.total}</td>
                            <td><b>${o.status}</b></td>
                            <td>
                                <select onchange="updateStatus('${doc.id}', this.value, '${o.userEmail}')">
                                    <option value="" disabled selected>Change Status</option>
                                    <option value="Confirmed">Confirmed</option>
                                    <option value="Delivered">Delivered</option>
                                    <option value="Cancelled">Cancelled</option>
                                </select>
                            </td>
                        </tr>
                    `;
                }).join('');
            });
        }

        // --- UPDATE STATUS & NOTIFY ---
        function updateStatus(orderId, status, email) {
            db.collection("orders").doc(orderId).update({ status: status }).then(() => {
                
                // Determine Message
                let title = "Order Update";
                let msg = `Your order is now ${status}.`;
                if(status === "Confirmed") { title = "Order Confirmed ‚úÖ"; msg = "Your order has been confirmed and is processing."; }
                if(status === "Delivered") { title = "Delivered üéâ"; msg = "Your order has been successfully delivered."; }
                if(status === "Cancelled") { title = "Order Cancelled ‚ùå"; msg = "Your order was cancelled."; }

                // Send Notification
                db.collection("notifications").add({
                    userEmail: email,
                    title: title,
                    message: msg,
                    read: false,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });

                alert(`Status updated to ${status}`);
            });
        }

        // Check Admin
        const user = JSON.parse(localStorage.getItem('user'));
        if(!user || user.role !== 'admin') { alert("Admin Access Only"); window.location.href="index.html"; }
        else { loadOrders(); }

    </script>
</body>
</html>
