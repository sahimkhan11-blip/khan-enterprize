<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel | Realtime</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Poppins', sans-serif; padding: 20px; background: #f1f5f9; color: #333; }
        .container { max-width: 1200px; margin: auto; background: white; padding: 25px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); }
        .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #eee; padding-bottom: 15px; margin-bottom: 20px; }
        
        .tabs button { padding: 10px 25px; cursor: pointer; border: none; background: #e2e8f0; margin-right: 10px; border-radius: 8px; font-weight: 600; transition: 0.3s; }
        .tabs button.active { background: #2563eb; color: white; transform: scale(1.05); box-shadow: 0 5px 15px rgba(37, 99, 235, 0.3); }
        
        .section { display: none; animation: fadeIn 0.5s; } .section.active { display: block; }
        @keyframes fadeIn { from{opacity:0;} to{opacity:1;} }
        
        .admin-form { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; background: #f8fafc; padding: 25px; border-radius: 12px; margin-bottom: 20px; border: 1px solid #e2e8f0; }
        .full { grid-column: span 2; }
        input, select, textarea { width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; box-sizing: border-box; }
        .upload-box { border: 2px dashed #94a3b8; padding: 20px; text-align: center; cursor: pointer; background: white; grid-column: span 2; border-radius: 10px; }
        .upload-preview { max-height: 100px; display: none; margin-top: 10px; }
        .btn { padding: 10px 20px; border: none; color: white; border-radius: 6px; cursor: pointer; font-weight: 600; }
        .btn-add { background: #10b981; } .btn-del { background: #ef4444; } .btn-edit { background: #3b82f6; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { padding: 15px; border-bottom: 1px solid #eee; text-align: left; }
        th { background: #f8fafc; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header"><h2>‚öôÔ∏è Admin Dashboard</h2><a href="index.html" style="text-decoration:none; color:blue;">Go to Shop</a></div>
        <div class="tabs"><button class="active" onclick="tab('products')">üì¶ Products</button><button onclick="tab('orders')">üìã Orders</button></div>

        <div id="products" class="section active">
            <div class="admin-form">
                <input type="hidden" id="eid">
                <input type="text" id="pname" placeholder="Product Name">
                <input type="number" id="pprice" placeholder="Price (BDT)">
                <select id="pstock"><option value="true">In Stock</option><option value="false">Out of Stock</option></select>
                <textarea id="pdesc" class="full" rows="3" placeholder="Product Details"></textarea>
                <div class="upload-box" onclick="document.getElementById('pfile').click()">
                    <input type="file" id="pfile" hidden accept="image/*" onchange="imgH(this)">
                    <span>üì∑ Click to Upload Image</span><br><img id="pprev" class="upload-preview">
                </div>
                <div class="full"><button class="btn btn-add" id="addBtn" onclick="addP()">Add Product</button> <button class="btn" onclick="reset()" style="background:#666;">Clear</button></div>
            </div>
            <table><thead><tr><th>Image</th><th>Info</th><th>Price</th><th>Stock</th><th>Action</th></tr></thead><tbody id="plist"></tbody></table>
        </div>

        <div id="orders" class="section">
            <table><thead><tr><th>Customer</th><th>Address</th><th>Items</th><th>Status</th><th>Action</th></tr></thead><tbody id="olist"></tbody></table>
        </div>
    </div>

    <script>
        // ‚úÖ YOUR FIREBASE CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyD7Ou-smtd4ZSQFuCLWudr1N2m6Mex0QIA",
            authDomain: "khanshop-bd5a2.firebaseapp.com",
            projectId: "khanshop-bd5a2",
            storageBucket: "khanshop-bd5a2.firebasestorage.app",
            messagingSenderId: "355701836562",
            appId: "1:355701836562:web:b67d7d8722c442441501cb",
            measurementId: "G-93M8HS7JYB"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        const user = JSON.parse(localStorage.getItem('user'));
        if(!user || user.role!=='admin') window.location.href="index.html";

        let curImg = "";

        function tab(t) { document.querySelectorAll('.section').forEach(e=>e.classList.remove('active')); document.querySelectorAll('.tabs button').forEach(e=>e.classList.remove('active')); document.getElementById(t).classList.add('active'); event.target.classList.add('active'); }
        function imgH(i) { if(i.files[0]) { let r=new FileReader(); r.onload=e=>{curImg=e.target.result; document.getElementById('pprev').src=curImg; document.getElementById('pprev').style.display='block';}; r.readAsDataURL(i.files[0]); } }

        // REALTIME PRODUCTS
        db.collection("products").onSnapshot((snap) => {
            let html = "";
            snap.forEach(doc => {
                let p = doc.data();
                html += `<tr>
                    <td><img src="${p.img}" width="50" style="border-radius:5px;"></td>
                    <td><b>${p.name}</b><br><small>${(p.desc||'').substring(0,30)}...</small></td>
                    <td>${p.price}</td>
                    <td style="color:${p.inStock?'green':'red'}">${p.inStock?'In Stock':'Out'}</td>
                    <td><button class="btn btn-del" onclick="delP('${doc.id}')">Del</button></td>
                </tr>`;
            });
            document.getElementById('plist').innerHTML = html;
        });

        function addP() {
            const n=document.getElementById('pname').value, p=document.getElementById('pprice').value;
            if(n && p) {
                db.collection("products").add({
                    name: n, price: parseInt(p), desc: document.getElementById('pdesc').value,
                    inStock: document.getElementById('pstock').value==='true', img: curImg,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                reset(); alert("Product Added!");
            }
        }
        function delP(id) { if(confirm("Delete?")) db.collection("products").doc(id).delete(); }
        function reset() { document.getElementById('pname').value=''; document.getElementById('pprice').value=''; curImg=''; document.getElementById('pprev').style.display='none'; }

        // REALTIME ORDERS
        db.collection("orders").orderBy("timestamp", "desc").onSnapshot((snap) => {
            let html = "";
            snap.forEach(doc => {
                let o = doc.data();
                html += `<tr>
                    <td><b>${o.userName}</b><br>${o.phone}</td>
                    <td style="font-size:13px;">${o.address}</td>
                    <td>${o.items}<br><b>${o.total} BDT</b></td>
                    <td>
                        <select onchange="upS('${doc.id}',this.value, '${o.userEmail}')">
                            <option value="Pending" ${o.status=='Pending'?'selected':''}>Pending</option>
                            <option value="Confirmed" ${o.status=='Confirmed'?'selected':''}>Confirmed</option>
                            <option value="Delivered" ${o.status=='Delivered'?'selected':''}>Delivered</option>
                            <option value="Cancelled" ${o.status=='Cancelled'?'selected':''}>Cancelled</option>
                        </select>
                    </td>
                    <td><button class="btn btn-del" onclick="delO('${doc.id}')">X</button></td>
                </tr>`;
            });
            document.getElementById('olist').innerHTML = html;
        });

        function upS(id, status, email) {
            db.collection("orders").doc(id).update({ status: status });
            db.collection("notifications").add({
                userEmail: email, title: `Order ${status}`, 
                message: `Your order is now ${status}`, read: false, 
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });
        }
        function delO(id) { if(confirm("Delete?")) db.collection("orders").doc(id).delete(); }
    </script>
</body>
</html>
