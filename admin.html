<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel | Khan Enterprize</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Poppins', sans-serif; padding: 20px; background: #f1f5f9; color: #333; margin: 0; }
        .container { max-width: 1200px; margin: auto; background: white; padding: 25px; border-radius: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); }
        
        /* Header & Tabs */
        .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #eee; padding-bottom: 15px; margin-bottom: 20px; }
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; }
        .tab-btn { padding: 10px 20px; cursor: pointer; background: #e2e8f0; border: none; border-radius: 5px; font-weight: 600; font-size: 14px; }
        .tab-btn.active { background: #2563eb; color: white; }
        
        /* Forms */
        .admin-form { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; background: #f8fafc; padding: 20px; border-radius: 8px; margin-bottom: 30px; border: 1px solid #e2e8f0; }
        .full-width { grid-column: span 2; }
        input, select, textarea { width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 6px; box-sizing: border-box; font-family: inherit; }
        
        /* Image Upload Box */
        .upload-box {
            border: 2px dashed #cbd5e1;
            padding: 20px;
            text-align: center;
            border-radius: 8px;
            cursor: pointer;
            background: white;
            transition: 0.3s;
            position: relative;
            grid-column: span 2;
        }
        .upload-box:hover { border-color: #2563eb; background: #eff6ff; }
        .upload-preview { max-height: 100px; margin-top: 10px; display: none; border-radius: 5px; border: 1px solid #ddd; }

        /* Buttons */
        .btn { padding: 10px 20px; border-radius: 5px; cursor: pointer; border: none; font-weight: 600; color: white; }
        .btn-add { background: #10b981; }
        .btn-update { background: #f59e0b; display: none; }
        .btn-cancel { background: #64748b; display: none; }
        .btn-home { background: #2563eb; text-decoration: none; padding: 8px 15px; border-radius: 5px; font-size: 13px; color: white; }

        /* Tables */
        .table-responsive { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; min-width: 800px; }
        th, td { padding: 12px; border-bottom: 1px solid #eee; text-align: left; vertical-align: middle; font-size: 14px; }
        th { background: #f1f5f9; font-weight: 600; color: #475569; }
        
        .action-btn { padding: 5px 10px; border-radius: 4px; cursor: pointer; border: none; color: white; font-size: 12px; margin-right: 5px; }
        .btn-edit { background: #3b82f6; }
        .btn-del { background: #ef4444; }

        /* Status Select */
        .status-select { padding: 5px; border-radius: 4px; font-weight: bold; cursor: pointer; }
        
        /* Hide Sections Logic */
        .section { display: none; }
        .section.active { display: block; }
    </style>
</head>
<body>

    <div class="container">
        <div class="header">
            <h2>‚öôÔ∏è Admin Dashboard</h2>
            <a href="index.html" class="btn-home">üè† Go to Shop</a>
        </div>

        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('products')">üì¶ Manage Products</button>
            <button class="tab-btn" onclick="switchTab('orders')">üìã Manage Orders</button>
        </div>

        <div id="products" class="section active">
            
            <div class="admin-form">
                <h3 class="full-width" style="margin-top:0;">Add / Edit Product</h3>
                <input type="hidden" id="edit_id">
                
                <input type="text" id="p_name" placeholder="Product Name">
                <input type="number" id="p_price" placeholder="Price (BDT)">
                
                <div class="upload-box" onclick="document.getElementById('p_file').click()">
                    <input type="file" id="p_file" hidden accept="image/*" onchange="handleImage(this)">
                    <span id="upload-text">üìÇ Click to Upload Image (or Drag here)</span>
                    <br>
                    <img id="p_preview" class="upload-preview">
                </div>

                <div class="full-width">
                    <button class="btn btn-add" id="addBtn" onclick="addProduct()">Add Product</button>
                    <button class="btn btn-update" id="updateBtn" onclick="updateProduct()">Update Product</button>
                    <button class="btn btn-cancel" id="cancelBtn" onclick="resetForm()">Cancel</button>
                </div>
            </div>

            <h3>Product List</h3>
            <div class="table-responsive">
                <table>
                    <thead>
                        <tr>
                            <th>Image</th>
                            <th>Name</th>
                            <th>Price</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="product-list"></tbody>
                </table>
            </div>
        </div>

        <div id="orders" class="section">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h3>Customer Orders</h3>
                <button onclick="renderOrders()" class="btn" style="background:#f59e0b; font-size:12px;">üîÑ Refresh</button>
            </div>
            
            <div class="table-responsive">
                <table>
                    <thead>
                        <tr>
                            <th>Order ID</th>
                            <th>Customer</th>
                            <th>Location</th>
                            <th>Items & Total</th>
                            <th>Status</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="order-list"></tbody>
                </table>
            </div>
        </div>

    </div>

    <script>
        // --- AUTH CHECK ---
        const user = JSON.parse(localStorage.getItem('user'));
        if(!user || user.role !== 'admin') { 
            alert("Access Denied!"); 
            window.location.href="index.html"; 
        }

        // --- GLOBAL VARIABLES ---
        let products = JSON.parse(localStorage.getItem('products')) || [];
        let orders = JSON.parse(localStorage.getItem('orders')) || [];
        let currentImageBase64 = "";

        // --- TAB SWITCHING ---
        function switchTab(tabName) {
            document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
            
            if(tabName === 'products') renderProducts();
            if(tabName === 'orders') renderOrders();
        }

        // ================= PRODUCT LOGIC =================

        // 1. Handle Image Upload
        function handleImage(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    currentImageBase64 = e.target.result;
                    document.getElementById('p_preview').src = currentImageBase64;
                    document.getElementById('p_preview').style.display = "block";
                    document.getElementById('upload-text').innerText = "‚úÖ Image Selected";
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        // 2. Add Product
        function addProduct() {
            const name = document.getElementById('p_name').value;
            const price = document.getElementById('p_price').value;
            
            if(!name || !price) return alert("Please fill Name and Price");
            if(!currentImageBase64) return alert("Please upload an image");

            const newProduct = {
                id: Date.now(),
                name: name,
                price: parseInt(price),
                img: currentImageBase64
            };

            products.push(newProduct);
            localStorage.setItem('products', JSON.stringify(products));
            
            renderProducts();
            resetForm();
            alert("Product Added Successfully!");
        }

        // 3. Edit Product (Load data into form)
        function editProduct(id) {
            const product = products.find(p => p.id === id);
            if(product) {
                document.getElementById('edit_id').value = id;
                document.getElementById('p_name').value = product.name;
                document.getElementById('p_price').value = product.price;
                
                currentImageBase64 = product.img;
                document.getElementById('p_preview').src = product.img;
                document.getElementById('p_preview').style.display = "block";
                document.getElementById('upload-text').innerText = "Change Image (Optional)";

                // Toggle Buttons
                document.getElementById('addBtn').style.display = 'none';
                document.getElementById('updateBtn').style.display = 'inline-block';
                document.getElementById('cancelBtn').style.display = 'inline-block';
                
                // Scroll to form
                window.scrollTo(0,0);
            }
        }

        // 4. Update Product
        function updateProduct() {
            const id = parseInt(document.getElementById('edit_id').value);
            const name = document.getElementById('p_name').value;
            const price = document.getElementById('p_price').value;

            const idx = products.findIndex(p => p.id === id);
            if(idx !== -1) {
                products[idx].name = name;
                products[idx].price = parseInt(price);
                // Only update image if a new one was selected, else keep old one
                if(currentImageBase64) {
                    products[idx].img = currentImageBase64;
                }

                localStorage.setItem('products', JSON.stringify(products));
                renderProducts();
                resetForm();
                alert("Product Updated!");
            }
        }

        // 5. Delete Product
        function deleteProduct(id) {
            if(confirm("Are you sure you want to delete this product?")) {
                products = products.filter(p => p.id !== id);
                localStorage.setItem('products', JSON.stringify(products));
                renderProducts();
            }
        }

        // 6. Reset Form
        function resetForm() {
            document.getElementById('p_name').value = "";
            document.getElementById('p_price').value = "";
            document.getElementById('p_file').value = "";
            document.getElementById('edit_id').value = "";
            currentImageBase64 = "";
            
            document.getElementById('p_preview').style.display = "none";
            document.getElementById('upload-text').innerText = "üìÇ Click to Upload Image";

            document.getElementById('addBtn').style.display = 'inline-block';
            document.getElementById('updateBtn').style.display = 'none';
            document.getElementById('cancelBtn').style.display = 'none';
        }

        // 7. Render Products List
        function renderProducts() {
            // Reload from storage to ensure sync
            products = JSON.parse(localStorage.getItem('products')) || [];
            const list = document.getElementById('product-list');
            
            if(products.length === 0) {
                list.innerHTML = "<tr><td colspan='4' style='text-align:center'>No products found. Add one!</td></tr>";
                return;
            }

            list.innerHTML = products.map(p => `
                <tr>
                    <td><img src="${p.img}" style="width:50px; height:50px; object-fit:cover; border-radius:4px;"></td>
                    <td>${p.name}</td>
                    <td>${p.price} BDT</td>
                    <td>
                        <button class="action-btn btn-edit" onclick="editProduct(${p.id})">Edit</button>
                        <button class="action-btn btn-del" onclick="deleteProduct(${p.id})">Delete</button>
                    </td>
                </tr>
            `).join('');
        }

        // ================= ORDER LOGIC =================

        function renderOrders() {
            // Reload orders
            orders = JSON.parse(localStorage.getItem('orders')) || [];
            const list = document.getElementById('order-list');

            if(orders.length === 0) {
                list.innerHTML = "<tr><td colspan='6' style='text-align:center'>No orders yet.</td></tr>";
                return;
            }

            list.innerHTML = orders.map(o => `
                <tr>
                    <td><small>#${o.id.toString().slice(-5)}</small><br>${o.time}</td>
                    <td><b>${o.userName}</b><br>${o.phone}</td>
                    <td><small>${o.address || 'N/A'}</small></td>
                    <td>${o.items}<br><b>Total: ${o.total}</b></td>
                    <td>
                        <select class="status-select" onchange="updateStatus(${o.id}, this.value)" style="border-color:${getStatusColor(o.status)}">
                            <option value="Pending" ${o.status==='Pending'?'selected':''}>Pending</option>
                            <option value="Confirmed" ${o.status==='Confirmed'?'selected':''}>Confirmed</option>
                            <option value="Delivered" ${o.status==='Delivered'?'selected':''}>Delivered</option>
                            <option value="Cancelled" ${o.status==='Cancelled'?'selected':''}>Cancelled</option>
                        </select>
                    </td>
                    <td><button class="action-btn btn-del" onclick="deleteOrder(${o.id})">‚ùå</button></td>
                </tr>
            `).join('');
        }

        function updateStatus(id, newStatus) {
            const idx = orders.findIndex(o => o.id === id);
            if(idx !== -1) {
                orders[idx].status = newStatus;
                localStorage.setItem('orders', JSON.stringify(orders));
                
                // Send Notification Logic
                let notifications = JSON.parse(localStorage.getItem('notifications')) || [];
                notifications.push({
                    id: Date.now(), userEmail: orders[idx].userEmail,
                    title: `Order ${newStatus}`, message: `Your order is now ${newStatus}.`,
                    read: false, time: new Date().toLocaleString()
                });
                localStorage.setItem('notifications', JSON.stringify(notifications));
                
                renderOrders(); // Refresh UI to update color
            }
        }

        function deleteOrder(id) {
            if(confirm("Delete this order history?")) {
                orders = orders.filter(o => o.id !== id);
                localStorage.setItem('orders', JSON.stringify(orders));
                renderOrders();
            }
        }

        function getStatusColor(status) {
            if(status === 'Confirmed') return '#2563eb';
            if(status === 'Delivered') return '#10b981';
            if(status === 'Cancelled') return '#ef4444';
            return '#f59e0b';
        }

        // Initial Load
        renderProducts();
    </script>
</body>
</html>
