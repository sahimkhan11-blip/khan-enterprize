<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel | Khan Enterprize</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Poppins', sans-serif; padding: 20px; background: #f1f5f9; color: #333; }
        .container { max-width: 1200px; margin: auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        
        /* Header */
        .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #eee; padding-bottom: 15px; margin-bottom: 20px; }
        .header h2 { margin: 0; color: #1e293b; }
        .btn { text-decoration: none; padding: 8px 15px; border-radius: 5px; font-weight: 600; font-size: 13px; cursor: pointer; border: none; }
        .btn-home { background: #2563eb; color: white; }
        .btn-clear { background: #ef4444; color: white; }

        /* Table */
        .table-responsive { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; min-width: 900px; }
        th, td { padding: 12px; border-bottom: 1px solid #eee; text-align: left; vertical-align: middle; }
        th { background: #f8fafc; font-weight: 600; color: #64748b; }
        tr:hover { background: #fdfdfd; }

        /* Status Badges */
        .status-select { padding: 5px; border-radius: 4px; border: 1px solid #ddd; font-weight: bold; cursor: pointer; }
        .status-Pending { color: #f59e0b; border-color: #f59e0b; }
        .status-Confirmed { color: #2563eb; border-color: #2563eb; }
        .status-Delivered { color: #10b981; border-color: #10b981; }
        .status-Cancelled { color: #ef4444; border-color: #ef4444; }

        /* Details */
        .customer-info { font-size: 13px; line-height: 1.4; }
        .customer-info b { display: block; font-size: 14px; color: #333; }
        .items-list { font-size: 13px; color: #555; }
        .price-tag { font-weight: bold; color: #2563eb; }
    </style>
</head>
<body>

    <div class="container">
        <div class="header">
            <h2>üì¶ Order Management</h2>
            <div>
                <button onclick="renderOrders()" class="btn" style="background:#f59e0b; color:black; margin-right:5px;">üîÑ Refresh</button>
                <button onclick="clearAll()" class="btn btn-clear">üóë Clear All</button>
                <a href="index.html" class="btn btn-home">üè† Go to Shop</a>
            </div>
        </div>

        <div class="table-responsive">
            <table id="order-table">
                <thead>
                    <tr>
                        <th>Order ID & Time</th>
                        <th>Customer Info</th>
                        <th>Shipping Address</th>
                        <th>Items & Total</th>
                        <th>Method</th>
                        <th>Status</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="order-list">
                    </tbody>
            </table>
        </div>
    </div>

    <script>
        // --- ADMIN CHECK ---
        const user = JSON.parse(localStorage.getItem('user'));
        if(!user || user.role !== 'admin') { 
            alert("‚ö† Access Denied! You are not an Admin."); 
            window.location.href="index.html"; 
        }

        // --- RENDER ORDERS ---
        function renderOrders() {
            const orders = JSON.parse(localStorage.getItem('orders')) || [];
            const list = document.getElementById('order-list');
            
            if(orders.length === 0) {
                list.innerHTML = '<tr><td colspan="7" style="text-align:center; padding:20px; color:#888;">No orders received yet.</td></tr>';
                return;
            }

            list.innerHTML = orders.map(o => `
                <tr>
                    <td>
                        <span style="font-weight:bold; color:#333;">#${o.id.toString().slice(-6)}</span><br>
                        <small style="color:#888;">${o.time || 'N/A'}</small>
                    </td>
                    <td>
                        <div class="customer-info">
                            <b>${o.userName}</b>
                            üìû ${o.phone}<br>
                            ‚úâÔ∏è ${o.userEmail}
                        </div>
                    </td>
                    <td>
                        <div style="font-size:12px; width:180px; line-height:1.4;">
                            ${o.address}
                        </div>
                    </td>
                    <td>
                        <div class="items-list">${o.items}</div>
                        <div class="price-tag">${o.total} BDT</div>
                    </td>
                    <td><span style="background:#eee; padding:2px 6px; border-radius:4px; font-size:11px;">${o.method || 'COD'}</span></td>
                    <td>
                        <select class="status-select status-${o.status}" onchange="updateStatus(${o.id}, this.value)">
                            <option value="Pending" ${o.status==='Pending'?'selected':''}>Pending</option>
                            <option value="Confirmed" ${o.status==='Confirmed'?'selected':''}>Confirmed</option>
                            <option value="Delivered" ${o.status==='Delivered'?'selected':''}>Delivered</option>
                            <option value="Cancelled" ${o.status==='Cancelled'?'selected':''}>Cancelled</option>
                        </select>
                    </td>
                    <td>
                        <button onclick="deleteOrder(${o.id})" style="background:none; border:none; cursor:pointer; font-size:16px;" title="Delete Order">‚ùå</button>
                    </td>
                </tr>
            `).join('');
        }

        // --- UPDATE STATUS ---
        function updateStatus(id, newStatus) {
            let orders = JSON.parse(localStorage.getItem('orders'));
            const idx = orders.findIndex(o => o.id === id);
            
            if(idx !== -1) {
                orders[idx].status = newStatus;
                localStorage.setItem('orders', JSON.stringify(orders));
                
                // Send Notification to User
                sendNotification(orders[idx].userEmail, newStatus, id);
                
                renderOrders(); // Refresh table
            }
        }

        // --- SEND NOTIFICATION ---
        function sendNotification(email, status, orderId) {
            let notifications = JSON.parse(localStorage.getItem('notifications')) || [];
            
            let title = "Order Updated üì¶";
            let msg = `Your order #${orderId.toString().slice(-6)} is now ${status}.`;

            if(status === 'Confirmed') { title="Order Confirmed ‚úÖ"; msg="We have received your order and are processing it."; }
            if(status === 'Delivered') { title="Delivered üéâ"; msg="Your order has been delivered. Thank you!"; }
            if(status === 'Cancelled') { title="Order Cancelled ‚ùå"; msg="Your order was cancelled. Contact us for help."; }

            notifications.push({
                id: Date.now(),
                userEmail: email,
                title: title,
                message: msg,
                read: false,
                time: new Date().toLocaleString()
            });
            localStorage.setItem('notifications', JSON.stringify(notifications));
        }

        // --- DELETE ORDER ---
        function deleteOrder(id) {
            if(confirm("Are you sure you want to delete this order history?")) {
                let orders = JSON.parse(localStorage.getItem('orders'));
                orders = orders.filter(o => o.id !== id);
                localStorage.setItem('orders', JSON.stringify(orders));
                renderOrders();
            }
        }

        // --- CLEAR ALL ---
        function clearAll() {
            if(confirm("WARNING: This will delete ALL orders forever!")) {
                localStorage.removeItem('orders');
                renderOrders();
            }
        }

        // Auto Refresh every 3 seconds to check for new orders
        setInterval(renderOrders, 3000);

        // Initial Load
        renderOrders();
    </script>
</body>
</html>
